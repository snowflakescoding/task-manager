<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.png') }}" type="image/png">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>

    <div class="container">
        
        <div class="controls-wrapper">
            <select id="lang-switch" class="lang-select" onchange="changeLanguage(this.value)">
                <option value="en">ðŸ‡ºðŸ‡¸ EN</option>
                <option value="vi">ðŸ‡»ðŸ‡³ VI</option>
                <option value="ja">ðŸ‡¯ðŸ‡µ JA</option>
            </select>

            <label class="switch" title="Toggle Dark Mode">
                <input type="checkbox" id="checkbox" onchange="toggleTheme(this)">
                <span class="slider"></span>
            </label>
        </div>

        <h1 data-key="app_title">Task Manager</h1>

        <div id="auth-section">
            <h3 data-key="login_header">Login</h3>
            <input type="text" id="username" placeholder="Enter Username" data-ph="ph_username">
            <input type="password" id="password" placeholder="Enter Password" data-ph="ph_password">
            
            <button onclick="auth('login')" class="btn-primary" data-key="btn_login">Login</button>
            <button onclick="auth('register')" class="btn-secondary" data-key="btn_register">Register New User</button>
            
            <p id="auth-msg" style="color: #e74c3c; text-align: center; margin-top: 10px;"></p>
        </div>

        <div id="task-section" class="hidden">
            <h3 data-key="my_tasks">My Tasks</h3>
            
            <div style="display: flex; gap: 5px;">
                <input type="text" id="task-content" placeholder="What needs to be done?" data-ph="ph_task">
                <button onclick="addTask()" class="btn-primary" style="width: auto;" data-key="btn_add">Add</button>
            </div>

            <div id="task-list">
                </div>

            <button onclick="logout()" class="btn-secondary" style="margin-top: 20px;" data-key="btn_logout">Logout</button>
        </div>

        <div class="footer">
            <p>Version 0.6.0</p>
            <p><span data-key="created_by">Created by</span> <strong>SnowFlakes</strong></p>
            <a href="https://github.com/snowflakescoding/task-manager" target="_blank" data-key="view_source">View Source on GitHub</a>
        </div>

    </div>

    <script>
        // --- TRANSLATION DICTIONARY ---
        const translations = {
            en: {
                app_title: "Task Manager",
                login_header: "Login",
                ph_username: "Enter Username",
                ph_password: "Enter Password",
                btn_login: "Login",
                btn_register: "Register New User",
                my_tasks: "My Tasks",
                ph_task: "What needs to be done?",
                btn_add: "Add",
                btn_logout: "Logout",
                btn_delete: "Delete",
                created_by: "Created by",
                view_source: "View Source on GitHub",
                // Server Messages
                msg_fill_fields: "Please fill in all fields.",
                msg_registered: "Registration successful! Please login.",
                err_user_exists: "Username already exists",
                err_invalid: "Invalid credentials",
                err_unauthorized: "Unauthorized"
            },
            vi: {
                app_title: "Quáº£n LÃ½ CÃ´ng Viá»‡c",
                login_header: "ÄÄƒng Nháº­p",
                ph_username: "Nháº­p tÃªn Ä‘Äƒng nháº­p",
                ph_password: "Nháº­p máº­t kháº©u",
                btn_login: "ÄÄƒng Nháº­p",
                btn_register: "ÄÄƒng KÃ½ Má»›i",
                my_tasks: "Danh SÃ¡ch CÃ´ng Viá»‡c",
                ph_task: "Báº¡n cáº§n lÃ m gÃ¬?",
                btn_add: "ThÃªm",
                btn_logout: "ÄÄƒng Xuáº¥t",
                btn_delete: "XÃ³a",
                created_by: "ÄÆ°á»£c táº¡o bá»Ÿi",
                view_source: "Xem mÃ£ nguá»“n trÃªn GitHub",
                // Server Messages
                msg_fill_fields: "Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin.",
                msg_registered: "ÄÄƒng kÃ½ thÃ nh cÃ´ng! Vui lÃ²ng Ä‘Äƒng nháº­p.",
                err_user_exists: "TÃªn Ä‘Äƒng nháº­p Ä‘Ã£ tá»“n táº¡i",
                err_invalid: "Sai thÃ´ng tin Ä‘Äƒng nháº­p",
                err_unauthorized: "KhÃ´ng cÃ³ quyá»n truy cáº­p"
            },
            ja: {
                app_title: "ã‚¿ã‚¹ã‚¯ç®¡ç†",
                login_header: "ãƒ­ã‚°ã‚¤ãƒ³",
                ph_username: "ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›",
                ph_password: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›",
                btn_login: "ãƒ­ã‚°ã‚¤ãƒ³",
                btn_register: "æ–°è¦ç™»éŒ²",
                my_tasks: "ãƒžã‚¤ã‚¿ã‚¹ã‚¯",
                ph_task: "ä½•ã‚’ã—ã¾ã™ã‹ï¼Ÿ",
                btn_add: "è¿½åŠ ",
                btn_logout: "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ",
                btn_delete: "å‰Šé™¤",
                created_by: "ä½œæˆè€…:",
                view_source: "GitHubã§ã‚½ãƒ¼ã‚¹ã‚’è¦‹ã‚‹",
                // Server Messages
                msg_fill_fields: "ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
                msg_registered: "ç™»éŒ²å®Œäº†ï¼ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚",
                err_user_exists: "ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™",
                err_invalid: "èªè¨¼æƒ…å ±ãŒç„¡åŠ¹ã§ã™",
                err_unauthorized: "è¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“"
            }
        };

        let currentLang = localStorage.getItem('lang') || 'en';

        // --- 1. LANGUAGE LOGIC ---
        function changeLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang);
            document.getElementById('lang-switch').value = lang;

            // Update Text Content (h1, h3, buttons, spans, a)
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if (translations[lang][key]) {
                    el.innerText = translations[lang][key];
                }
            });

            // Update Placeholders (inputs)
            document.querySelectorAll('[data-ph]').forEach(el => {
                const key = el.getAttribute('data-ph');
                if (translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });

            // Update any Dynamic Delete buttons
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.innerText = translations[lang]['btn_delete'];
            });
        }

        // Apply preferences on load
        window.onload = function() {
            // Apply Theme
            const currentTheme = localStorage.getItem('theme');
            if (currentTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('checkbox').checked = true;
            }
            // Apply Language
            changeLanguage(currentLang);
        };

        // --- 2. DARK MODE LOGIC ---
        function toggleTheme(e) {
            if (e.checked) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
            }
        }

        // --- 3. HELPER: TRANSLATE SERVER MESSAGES ---
        function getTranslatedMsg(serverMsg) {
            // Map raw server strings to translation keys
            const map = {
                "Username already exists": "err_user_exists",
                "Invalid credentials": "err_invalid",
                "Unauthorized": "err_unauthorized",
                "User created!": "msg_registered"
                // Success login is handled by UI switch, not text
            };
            
            const key = map[serverMsg];
            return (key && translations[currentLang][key]) ? translations[currentLang][key] : serverMsg;
        }

        // --- 4. AUTHENTICATION LOGIC ---
        async function auth(endpoint) {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const msg = document.getElementById('auth-msg');

            if (!user || !pass) {
                msg.innerText = translations[currentLang]['msg_fill_fields'];
                return;
            }

            const res = await fetch(`/${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: user, password: pass })
            });

            const data = await res.json();
            
            if (res.ok) {
                msg.innerText = "";
                if(endpoint === 'login') {
                    document.getElementById('auth-section').classList.add('hidden');
                    document.getElementById('task-section').classList.remove('hidden');
                    loadTasks();
                } else {
                    msg.style.color = "green";
                    // Translate the success message
                    msg.innerText = getTranslatedMsg("User created!"); 
                }
            } else {
                msg.style.color = "red";
                // Translate the error message
                msg.innerText = getTranslatedMsg(data.error);
            }
        }

        function logout() {
            location.reload(); 
        }

        // --- 5. TASK MANAGEMENT LOGIC ---
        async function loadTasks() {
            const res = await fetch('/tasks');
            const tasks = await res.json();
            const list = document.getElementById('task-list');
            list.innerHTML = '';
            tasks.forEach(task => {
                // We add the 'btn-delete' class so changeLanguage() can find it later
                const deleteText = translations[currentLang]['btn_delete'];
                list.innerHTML += `
                    <div class="task-item">
                        <span>${task.content}</span>
                        <button onclick="deleteTask(${task.id})" class="btn-delete">${deleteText}</button>
                    </div>`;
            });
        }

        async function addTask() {
            const content = document.getElementById('task-content').value;
            if(!content) return;
            
            await fetch('/tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: content })
            });
            document.getElementById('task-content').value = '';
            loadTasks();
        }

        async function deleteTask(id) {
            await fetch('/tasks', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id })
            });
            loadTasks();
        }
    </script>
</body>
</html>